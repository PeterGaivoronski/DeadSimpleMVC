(function(){var a=true;var b,c;if(typeof P==="undefined"){a=false;b="P.js for object classes";c="https://github.com/jayferd/pjs";}else if(typeof jQuery==="undefined"){a=false;b="jQuery for DOM manipulation";c="http://jquery.com/";}else if(typeof uuid==="undefined"){a=false;b="node-uuid for unique model IDs";c="https://github.com/broofa/node-uuid";}else if(typeof jQuery.publish==="undefined"){a=false;b="jQuery pubsub for publish/subscribe functionality";c="https://github.com/cowboy/jquery-tiny-pubsub";}else if(typeof jQuery.mergeSort==="undefined"){a=false;b="Merge-sort to sort things in place in all browsers";c="https://github.com/justinforce/merge-sort";}if(a===false){console.error("ERROR: Dead Simple MVC needs "+b+". Download at: "+c);return;}(function(a,b,c,d){var e={};var f=a(function(a){a._id=undefined;a._deleted=false;a.init=function(){this._id=c.v4();};a.subscribe=function(a,c){b.subscribe(a+"."+this._id,c);};a.unsubscribe=function(a){b.unsubscribe(a+"."+this._id);};a.unsubscribeAll=function(){b.unsubscribe("."+this._id);};a.del=function(){this._deleted=true;this.unsubscribeAll();};});e.DSClass=f;var g=a(f,function(a,c){a.init=function(a){c.init.call(this);this.modify(a);e.ModelRegistry[this._id]=this;};a.publish=function(a){b.publish('/models/'+a,[this]);};a.modify=function(a){for(var b in a)if(this.validate(b,a[b]))this[b]=a[b];this.publish("modify");};a.del=function(){delete e.ModelRegistry[this._id];c.del.call(this);this.publish("delete");console.log("delete pub sent");};a.validate=function(a,b){return true;};a.serialize=function(a,b){var c={};for(var d in this)if(typeof this[d]!=="function")switch(d){case '_id':case '_deleted':if(a!==true)c[d]=this[d];break;default:c[d]=this[d];break;}c=JSON.stringify(c);if(b!==true)return c;else return JSON.parse(c);};});e.Model=g;e.ModelRegistry={};var h=a(f,function(a,c){a.elements=undefined;a.registry=undefined;a.init=function(a,d){c.init.call(this);this.registry=d;this.elements=[];for(var f=0;f<a.length;f++)this.addElement(a[f]);e.CollectionRegistry[this._id]=this;this.subscribe("/models/delete",b.proxy(this.deleteFunc,this));};a.addElement=function(a){this.elements.push(a._id);};a.removeElement=function(a){var b=[];for(var c=0;c<this.elements.length;c++)if(this.registry[this.elements[c]]!==a)b.push(this.elements[c]);this.elements=b;};a.deleteFunc=function(a,b){if(this.elements.indexOf(b._id)!==-1)this.removeElement(b);};a.del=function(){delete e.CollectionRegistry[this._id];c.del.call(this);};});e.Collection=h;e.CollectionRegistry={};var i=a(e.Collection,function(a,b){a.init=function(a){b.init.call(this,a,e.ModelRegistry);};a.sortByParam=function(a,b,c){var d=this.elements.mergeSort(function(c,d){var f=e.ModelRegistry[c];var g=e.ModelRegistry[d];if(f[a]>g[a])if(b===true)return 1;else return -1;if(f[a]<g[a])if(b===true)return -1;else return 1;return 0;});if(c===true)this.elements=d;else return d;};});e.ModelCollection=i;var j=a(f,function(a,c){a.DOM=undefined;a.actions=undefined;a.template=undefined;a.assignViewEvents=function(){for(var a in this.actions){var b=this.DOM.find(a);var c=this.actions[a];var d=0;for(var e in c){b.off(e);for(d=0;d<c[e].length;d++)(function(a,b,c,d,e){a.on(b,function(){c.sendViewEvent(d[b][e]);});})(b,e,this,c,d);}}};a.sendViewEvent=function(a){b.publish('/views/'+a,[this]);};});var k=a(j,function(a,c){a.model=undefined;a.init=function(a,d){c.init.call(this);if(a!==null)this.model=a._id;else this.model=null;this.subscribeModel("modify",b.proxy(this.modifyFunc,this));this.subscribeModel("delete",b.proxy(this.deleteFunc,this));this.DOM=d;this.render();e.ViewRegistry[this._id]=this;};a.render=function(){if(typeof this.model==="undefined")return;var a=this.renderTemplate();this.DOM.html(a);this.assignViewEvents();};a.getModel=function(){return e.ModelRegistry[this.model];};a.renderTemplate=function(){return this.template(this.genTemplateArguments());};a.genTemplateArguments=function(){return{model:e.ModelRegistry[this.model]};};a.subscribeModel=function(a,b){this.subscribe('/models/'+a,b);};a.unsubscribeModel=function(a){this.unsubscribe('/models/'+a);};a.modifyFunc=function(a,b){if(this.model===b._id)this.render();};a.deleteFunc=function(a,c){if(this.model===c._id){this.del();this.DOM.html("");b.publish("/views/delete",[this]);}};a.del=function(){this.model=undefined;delete e.ViewRegistry[this._id];c.del.call(this);};});e.View=k;e.ViewRegistry={};var l=a(j,function(a,c){a.models=undefined;a.modelViews=undefined;a.limitIndex=0;a.limit=null;a.currentSortProperties=undefined;a.viewClass=undefined;a.init=function(a,d,f){if(typeof f!=="undefined")this.limit=f;c.init.call(this);this.models=a;this.modelViews={};this.DOM=d;this.currentSortProperties={};this.refresh();this.subscribe('/collections/update',b.proxy(this.genNewViews,this));this.subscribe('/views/delete',b.proxy(this.refresh,this));e.MetaViewRegistry[this._id]=this;};a.clear=function(){var a=this.renderTemplate();this.DOM.html(a);this.assignViewEvents();};a.renderTemplate=function(){var a="<div class = 'content'></div>";if(this.template!==undefined)a=this.template(this.genTemplateArguments());return a;};a.genTemplateArguments=function(){return{};};a.appendView=function(a){if(this.modelViews[a]===undefined)this.createModelView(a);else{var b=e.ModelRegistry[a];var c=e.ViewRegistry[this.modelViews[a]];c.DOM=this.genViewDom(b);c.render();}};a.createModelView=function(a){var b=e.ModelRegistry[a];this.modelViews[a]=this.viewClass(b,this.genViewDom(b))._id;};a.genViewDom=function(a){return b("<div></div>").appendTo(this.DOM.find('.content'));};a.refresh=function(){this.removeDeleted();var a=this.sortModelsByProperties();this.clear();var b=a.length;if(this.limit!==null){if(this.limitIndex>a.length-1)return this.lastPage();b=this.limit+this.limitIndex;}if(b>a.length)b=a.length;for(var c=this.limitIndex;c<b;c++)this.appendView(a[c]);};a.genNewViews=function(a,b){if(b===this.models)this.refresh();};a.switchPage=function(a){if(a*this.limit>this.models.elements.length-1||a<0)return false;this.limitIndex=a*this.limit;this.refresh();};a.nextPage=function(){if(this.limitIndex+this.limit>this.models.elements.length-1)return false;this.limitIndex+=this.limit;this.refresh();};a.previousPage=function(){if(this.limitIndex-this.limit<0)return false;this.limitIndex-=this.limit;this.refresh();};a.firstPage=function(){this.switchPage(0);};a.lastPage=function(){return this.switchPage(Math.floor((this.models.elements.length-1)/this.limit));};a.getPage=function(){return Math.floor(this.limitIndex/this.limit);};a.removeDeleted=function(){for(var a in this.modelViews){var b=this.modelViews[a];var c=e.ModelRegistry[a];if(typeof e.ViewRegistry[b]==="undefined"||typeof c==="undefined"||e.ViewRegistry[b]._deleted===true){delete this.modelViews[a];this.models.removeElement(c);}}};a.sortModelsByProperties=function(){if(this.models instanceof i===true&&this.currentSortProperties.paramName!==undefined){var a=this.currentSortProperties.paramName;var b=true;if(this.currentSortProperties.ascending!==undefined)b=this.currentSortProperties.ascending;return this.models.sortByParam(a,b,false);}else return this.models.elements;};a.del=function(){delete e.MetaViewRegistry[this._id];c.del.call(this);};});e.MetaView=l;e.MetaViewRegistry={};var m=a(h,function(a,b){a.init=function(a){b.init.call(this,a,e.ViewRegistry);};a.hideAll=function(){for(var a=0;a<this.elements.length;a++)this.getObj(this.elements[a]).DOM.hide();;};a.showAll=function(){for(var a=0;a<this.elements.length;a++)this.getObj(this.elements[a]).DOM.show();;};a.getObj=function(a){var b=e.ViewRegistry[a];if(typeof b==="undefined"){b=e.MetaViewRegistry[a];if(typeof b==="undefined")return false;}return b;};});e.ViewGroup=m;var n=a(f,function(a,b){a.events=undefined;a.init=function(){b.init.call(this);for(var a in this.events)this.subscribe('/views/'+a,this.events[a]);e.ControllerRegistry[this._id]=this;};a.del=function(){delete e.ControllerRegistry[this._id];b.del.call(this);};});e.Controller=n;e.ControllerRegistry={};d.DeadSimpleMVC=e;})(P,jQuery,uuid,window);})();